import { parseTypeScriptSchema } from './schema-gen/typescript-type-parser';
import { generateSchemaCRUD } from './schema-gen/schema-crud-generator';
import { writeFileSync } from 'fs';

export function generateSchema(inputPath: string, outputPath: string): void {
  console.log(`ğŸ“– Parsing TypeScript schema from: ${inputPath}`);
  
  const schema = parseTypeScriptSchema(inputPath);
  
  if (schema.documents.size === 0) {
    throw new Error('No documents found in the schema file');
  }

  console.log(`ğŸ“Š Found ${schema.documents.size} document(s):`);
  for (const [name, doc] of schema.documents) {
    console.log(`  - ${name} (${doc.fields.length} fields)`);
  }
  
  if (schema.indexes.size > 0) {
    console.log(`ğŸ” Found ${schema.indexes.size} index(es):`);
    for (const [name, index] of schema.indexes) {
      console.log(`  - ${name} (${index.ownerDocument} -> ${index.itemDocument})`);
    }
  }
  
  if (schema.ownerships.length > 0) {
    console.log(`ğŸ”— Found ${schema.ownerships.length} ownership relation(s):`);
    for (const ownership of schema.ownerships) {
      console.log(`  - ${ownership.ownerDocument} owns ${ownership.ownedDocument} via ${ownership.ownerField}`);
    }
  }

  console.log('âš™ï¸  Generating TypeScript code...');
  
  // Generate CRUD functions
  const crudCode = generateSchemaCRUD(schema);
  
  // Combine everything
  const fullOutput = `// Auto-generated database functions
// Generated from: ${inputPath}
// Do not edit this file directly
// Generated at: ${new Date().toISOString()}

${crudCode}
`;

  console.log(`ğŸ’¾ Writing output to: ${outputPath}`);
  writeFileSync(outputPath, fullOutput);
  
  console.log('âœ… Schema generation completed successfully!');
}