var S=Object.defineProperty;var T=(t,e)=>()=>(t&&(e=t(t=0)),e);var E=(t,e)=>{for(var o in e)S(t,o,{get:e[o],enumerable:!0})};var w={};E(w,{dbClient:()=>k,getSession:()=>N,putAccount:()=>_,putIdentity:()=>P,putSession:()=>G});async function G(t){return{}}async function _(t){return{}}async function P(t){return{}}async function N(t){}var b,k,C=T(()=>{"use strict";b={async get(t){return{Item:void 0}},async put(t){return{}},async query(t){return{Items:[]}},async send(t){return{}}},k=b});var A=async(t,e)=>{try{let o=e.cookies.get("sessionId")||"temporary-session-id";return{ok:!0,tosAgreed:!1}}catch{return{ok:!1,reason:"NOT_LOGGED_IN"}}};var d,f,h,m;try{let t=await import("db");d=t.dbClient,f=t.putAccount,h=t.putIdentity,m=t.putSession}catch{let t=await Promise.resolve().then(()=>(C(),w));d=t.dbClient,f=t.putAccount,h=t.putIdentity,m=t.putSession}async function g(){let t=new Uint8Array(16);crypto.getRandomValues(t),t[6]=t[6]&15|64,t[8]=t[8]&63|128;let e=Array.from(t,o=>o.toString(16).padStart(2,"0")).join("");return`${e.slice(0,8)}-${e.slice(8,12)}-${e.slice(12,16)}-${e.slice(16,20)}-${e.slice(20,32)}`}async function O(t){try{let e=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({code:t.authorizationCode,client_id:process.env.GOOGLE_CLIENT_ID,client_secret:process.env.GOOGLE_CLIENT_SECRET,redirect_uri:process.env.GOOGLE_REDIRECT_URI,grant_type:"authorization_code"})});if(!e.ok)return console.error("Token exchange failed:",await e.text()),{ok:!1,reason:"INVALID_CODE"};let o=await e.json(),n=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${o.access_token}`}});if(!n.ok)return console.error("User info fetch failed:",await n.text()),{ok:!1,reason:"GOOGLE_API_ERROR"};let r=await n.json(),s=r.id,p=r.email,u=r.name,l=r.picture,i=await d.query({TableName:"main",KeyConditionExpression:"pk = :pk",ExpressionAttributeValues:{":pk":`identity/provider=google/providerId=${s}`}}),c;if(!i.Items||i.Items.length===0){c=await g();let a=new Date().toISOString();await f({id:c,createdAt:a,updatedAt:a});let y=await g();await h({id:y,accountId:c,provider:"google",providerId:s,email:p,name:u,profileImageUrl:l,createdAt:a,updatedAt:a}),await d.put({TableName:"main",Item:{$p:`identity/provider=google/providerId=${s}`,$s:"_",identityId:y}})}else{let a=i.Items[0].identityId;c=(await d.get({TableName:"main",Key:{$p:`identity/id=${a}`,$s:"_"}})).Item.accountId}let x=await g();return await m({id:x,userId:c}),{ok:!0}}catch(e){return console.error("Google login error:",e),{ok:!1,reason:"GOOGLE_API_ERROR"}}}var I={getMe:A,loginWithGoogle:O};var v=async(t,e)=>{try{if(t.httpMethod&&t.path){let o=t.path.slice(1);if(t.httpMethod==="GET"&&o==="health")return{statusCode:200,headers:{"Content-Type":"text/plain","Access-Control-Allow-Origin":"*"},body:"OK"};if(t.httpMethod==="POST"&&Object.keys(I).includes(o)){let n={};if(t.body)try{n=JSON.parse(t.body)}catch{n={}}let r=I[o];if(!r)return{statusCode:404,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"},body:JSON.stringify({error:"Handler not found"})};let s=new Map;t.headers?.Cookie&&t.headers.Cookie.split(";").forEach(u=>{let[l,i]=u.trim().split("=");l&&i&&s.set(l,i)});let p=await r(n,{cookies:s});return{statusCode:200,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type"},body:JSON.stringify(p)}}return t.httpMethod==="OPTIONS"?{statusCode:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type"},body:""}:{statusCode:404,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"},body:JSON.stringify({error:"Not Found"})}}return console.log("Non-HTTP event received:",t),{statusCode:200,body:JSON.stringify({message:"Event processed"})}}catch(o){return console.error("Lambda Error:",o),{statusCode:500,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"},body:JSON.stringify({error:"Internal Server Error"})}}};export{v as handler};
